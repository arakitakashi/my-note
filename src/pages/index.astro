---
import { Home } from '../components/Home';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { ensureCategories, slugifyCategory } from '../utils/category';

const entries = await getCollection('blog');

const postsWithCategories = entries
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .map((entry) => ({
    title: entry.data.title,
    excerpt: entry.data.description,
    published:entry.data.date,
    updated: entry.data.updated,
    categories: ensureCategories(entry.data.categories),
    href: `/blog/${entry.slug}`,
  }));

const categoryCount = new Map<string, number>();

postsWithCategories.forEach((post) => {
  post.categories.forEach((category) => {
    categoryCount.set(category, (categoryCount.get(category) ?? 0) + 1);
  });
});

const categories = [
  {
    name: 'All',
    count: postsWithCategories.length,
    href: '/',
    isActive: true,
  },
  ...Array.from(categoryCount.entries()).map(([name, count]) => ({
    name,
    count,
    href: `/category/${slugifyCategory(name)}`,
    isActive: false,
  })),
];

const postItems = postsWithCategories.map(({ title, excerpt, href, published, updated }) => ({
  title,
  excerpt,
  href,
  published,
  updated
}));
---
<BaseLayout>
  <Home
    categories={categories}
    posts={postItems}
  />
</BaseLayout>
