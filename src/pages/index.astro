---
import { Home } from '../components/Home';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const entries = await getCollection('blog');
const activeCategoryParam = Astro.url.searchParams.get('category');
const normalizedCategory = activeCategoryParam
  ? activeCategoryParam.toLowerCase()
  : 'all';

const posts = entries
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .map((entry) => ({
    title: entry.data.title,
    excerpt: entry.data.description,
    categories: entry.data.categories,
    href: `/blog/${entry.slug}`,
  }));

const categoryCount = new Map<string, number>();
const ensureCategories = (values: string[]) => (values.length === 0 ? ["Uncategorized"] : values);

posts.forEach((post) => {
  ensureCategories(post.categories).forEach((category) => {
    categoryCount.set(category, (categoryCount.get(category) ?? 0) + 1);
  });
});

const categories = [
  {
    name: 'All',
    count: posts.length,
    href: '/',
    isActive: normalizedCategory === 'all',
  },
  ...Array.from(categoryCount.entries()).map(([name, count]) => {
    const value = name.toLowerCase();
    return {
      name,
      count,
      href: `/?category=${encodeURIComponent(value)}`,
      isActive: normalizedCategory === value,
    };
  }),
];

const filteredPosts =
  normalizedCategory === 'all'
    ? posts
    : posts.filter((post) =>
        ensureCategories(post.categories).some(
          (category) => category.toLowerCase() === normalizedCategory
        )
      );

const postItems = filteredPosts.map(({ title, excerpt, href }) => ({
  title,
  excerpt,
  href,
}));
---
<BaseLayout>
  <Home
    categories={categories}
    posts={postItems}
  />
</BaseLayout>
