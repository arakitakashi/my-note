---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import styles from "../../styles/PostPage.module.css";
import PostShare from "../../components/PostShare";
import { ensureCategories } from "../../utils/category";

type Props = {
  post: CollectionEntry<"blog">;
};

export async function getStaticPaths() {
  const posts = await getCollection("blog");

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props as Props;

const { Content, headings } = await post.render();

const formatDate = (value: Date) =>
  value.toLocaleDateString("ja-JP", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
  });

const publishedDate = formatDate(post.data.date);
const updatedDate = post.data.updated ? formatDate(post.data.updated) : publishedDate;

const tocItems = headings
  .filter((heading) => heading.depth <= 3)
  .map((heading) => ({
    slug: heading.slug,
    text: heading.text,
    depth: heading.depth,
  }));

const categories = ensureCategories(post.data.categories);

const siteOrigin = Astro.site?.origin ?? Astro.url.origin;
const shareUrl = new URL(`/blog/${post.slug}`, siteOrigin).toString();

const pageTitle = `${post.data.title} | Araki Takashi's Note`;
const pageDescription = post.data.description ?? `${post.data.title} に関する記事です。`;
const publishedISO = post.data.date.toISOString();
const updatedISO = post.data.updated ? post.data.updated.toISOString() : undefined;
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  type="article"
  publishedTime={publishedISO}
  modifiedTime={updatedISO}
>
  <main class={styles.wrapper}>
    <div class={styles.layout}>
      <article class={styles.article}>
        <header class={styles.header}>
          <h1 class={styles.title}>{post.data.title}</h1>
          <div class={styles.metaSection}>
            <div class={styles.metaGrid}>
              <div class={styles.metaRow}>
                <span class={styles.metaLabel}>Date:</span>
                <span class={styles.metaValue}>{publishedDate}</span>
              </div>
              <div class={styles.metaRow}>
                <span class={styles.metaLabel}>Last update:</span>
                <span class={styles.metaValue}>{updatedDate}</span>
              </div>
            </div>
            <div class={styles.metaRow}>
              <span class={styles.metaLabel}>Categories:</span>
              <span class={styles.metaValue}>{categories.join(', ')}</span>
            </div>
          </div>
        </header>
        {tocItems.length === 0 ? null : (
          <nav
            aria-label="Table of contents"
            class={`${styles.toc} ${styles.tocMobile}`}
            data-toc-active-class={styles.tocLinkActive}
          >
            <h2 class={styles.tocTitle}>Table of contents</h2>
            <ol class={styles.tocList}>
              {tocItems.map((item) => (
                <li class={item.depth === 3 ? styles.tocItemNested : undefined}>
                  <a
                    href={`#${item.slug}`}
                    class={styles.tocLink}
                    data-toc-link={item.slug}
                  >
                    {item.text}
                  </a>
                </li>
              ))}
            </ol>
          </nav>
        )}
        <div class={styles.body}>
          <Content />
        </div>
      </article>
      <aside class={styles.sidebar}>
        <nav
          aria-label="Table of contents"
          class={`${styles.toc} ${styles.tocSidebar}`}
          data-toc-active-class={styles.tocLinkActive}
        >
          <h2 class={styles.tocTitle}>Table of contents</h2>
          {tocItems.length === 0 ? (
            <p class={styles.emptyToc}>見出しはまだありません。</p>
          ) : (
            <ol class={styles.tocList}>
              {tocItems.map((item) => (
                <li class={item.depth === 3 ? styles.tocItemNested : undefined}>
                  <a
                    href={`#${item.slug}`}
                    class={styles.tocLink}
                    data-toc-link={item.slug}
                  >
                    {item.text}
                  </a>
                </li>
              ))}
            </ol>
          )}
        </nav>
        <PostShare
          client:load
          url={shareUrl}
          title={post.data.title}
          className={styles.sharePanel}
        />
      </aside>
    </div>
  </main>
  <script type="module" src="/scripts/toc-observer.js" defer></script>
</BaseLayout>
